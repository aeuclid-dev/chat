<!doctype html>
<html lang="en" class="h-100">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.88.1">
    <title>X WEB VIDEO CHAT</title>
    <!-- <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/cover/"> -->
    <link href="./fontawesome/css/all.css" rel="stylesheet">
    <link href="./bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>
    <link href="cover.css" rel="stylesheet">
    <script src="./bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="./axios/axios.js"></script>
    <script>
      let requestModal = null;
      let responseModal = null;
      let request = null;
      const urlParams = new URLSearchParams(window.location.search);
      const userid = urlParams.get('userid');
      var client = new WebSocket("ws://localhost:3030/", "protocolOne");
      client.onopen = function (event) {
        client.send(JSON.stringify({message: 'open', userid}));
      };
      client.onmessage = function (event) {
        console.log(event.data);
        const json = JSON.parse(event.data);
        console.log(json);

        if(json.message === 'request chat') {
          if(json.result) {
            if(json.result === 'accept') {
            window.location.href=`./chat.html?userid=${userid}&to=${json.request.to}`;
            } else if(json.result === 'reject') {
              requestModal.hide();
            } else if(json.result === 'cancel') {
              responseModal.hide();
            }
          } else {
            request = json;
            responseModal.show();
          }
        } else if(json.message === 'wait') {
          window.location.href=`./chat.html?userid=${json.userid}&to=${json.to}`;
        }
      };
      client.onclose = function(event) {
        console.log(event);
      };
      client.onerror = function(event) {
        console.log(event);
      };
      function cancelReq() {
        if(request) {
          request.result = 'cancel';
          client.send(JSON.stringify(request));
        }
      }
      function accept() {
        if(request) {
          request.result = 'accept';
          client.send(JSON.stringify(request));
        }
      }
      function reject() {
        if(request) {
          request.result = 'reject';
          client.send(JSON.stringify(request));
        }
      }
      function requestChat(no) {
        // update modal data
        request = {message: 'request chat', request: {from: parseInt(userid), to: no}};
        client.send(JSON.stringify({message: 'request chat', request: {from: parseInt(userid), to: no}}));
      }
      function onListLoad() {
        requestModal = new bootstrap.Modal(document.getElementById('requestChatModal'), {focus:true});
        responseModal = new bootstrap.Modal(document.getElementById('responseChatModal'), {focus:true});
        axios.get('http://localhost:3000/v1/room/list/')
             .then(res => {
              console.log(res);
              if(res.data.message.result && res.data.message.result.length) {
                for(let i = 0; i < res.data.message.result.length;i++) {
                  if(userid == res.data.message.result[i].id) {
                    continue;
                  }
                  const element = document.createElement('div');
                  element.className="card bg-transparent text-dark text-white border border-secondary mb-2";
                  element.style = "width: 24rem;";
                  element.innerHTML = `<div class="card-body">
            <h5 class="card-title">
                <div class="row">
                    <div class="col-2">
                        <i class="far fa-user-circle fa-2x"></i>
                    </div>
                    <div class="col">
                        <div class="row">
                            <div class="col fs-6">${res.data.message.result[i].name}</div>
                        </div>
                        <div class="row">
                            <div class="col text-secondary fs-6">${res.data.message.result[i].id}@${res.data.message.result[i].email}</div>
                        </div>
                    </div>
                </div>
            </h5>
            <p class="card-text text-secondary fs-6">${res.data.message.result[i].description}</p>
            <p class="card-text text-secondary fs-6">
                <span><i class="far fa-heart"></i> ${res.data.message.result[i].like}</span><span class="ms-3">09:30 Nov 14, 2018</span>
            </p>
            <hr />
            <div class="card-text text-secondary fs-6">
                <span class="float-start"><i class="far fa-comment-alt"></i> 123 people are talking about this</span>
                <span class="float-end">
                  <a href="#" data-bs-toggle="modal" data-bs-target="#requestChatModal" onclick="requestChat(${res.data.message.result[i].id});"><i class="fas fa-chevron-right fa-sm"></i></a>
                </span>
            </div>
          </div>`;
                  document.getElementById('roomList').appendChild(element);
                }
              }
             });
      }
    </script>
  </head>
  <body class="d-flex h-100 text-center text-white bg-dark" onload="onListLoad();">
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
      <header class="mb-3">
        <div>
          <h3 class="float-md-start mb-0"><strong>X WEB VIDEO CHAT</strong></h3>
          <nav class="nav nav-masthead justify-content-center float-md-end">
            <a class="nav-link active" aria-current="page" href="#">HOME</a>
            <a class="nav-link" href="#">FEATURES</a>
            <a class="nav-link" href="#">LOGOUT</a>
          </nav>
        </div>
      </header>
      <footer class="text-white-50">
        <p>
          NOVEMBERIZING / PROJECT X / WEB VIDEO CHAT / LICENSE
        </p>
      </footer>
      <main class="mb-3 px-3 text-start row justify-content-center" id="roomList">
        <!-- style="width: 18rem;" -->

      </main>
    </div>
    <!-- Modal -->
    <div class="modal fade text-dark" id="requestChatModal" tabindex="-1" aria-labelledby="requestChatModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="requestChatModalLabel">Pooh</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body mx-auto">
            <div class="card bg-transparent text-start text-dark border border-secondary" style="width: 24rem;">
              <div class="card-body">
                <h5 class="card-title">
                    <div class="row">
                        <div class="col-2">
                            <i class="far fa-user-circle fa-2x"></i>
                        </div>
                        <div class="col">
                            <div class="row">
                                <div class="col fs-6">Pooh</div>
                            </div>
                            <div class="row">
                                <div class="col text-secondary fs-6">@Pooh</div>
                            </div>
                        </div>
                    </div>
                </h5>
                <p class="card-text text-secondary fs-6">Winnie-the-Pooh, also called Pooh Bear and Pooh, is a fictional anthropomorphic teddy bear created by English author A. A. Milne and English illustrator E. H. Shepard.</p>
                <p class="card-text text-secondary fs-6">
                    <span><i class="far fa-heart"></i> 4.5</span><span class="ms-3">09:30 Nov 14, 2018</span>
                </p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-dark" data-bs-dismiss="modal" onclick="cancelReq();">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    <!-- MODAL: START -->
    <div class="modal fade text-dark" id="responseChatModal" tabindex="-1" aria-labelledby="responseChatModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="responseChatModalLabel">Pooh</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body mx-auto">
            <div class="card bg-transparent text-start text-dark border border-secondary" style="width: 24rem;">
              <div class="card-body">
                <h5 class="card-title">
                    <div class="row">
                        <div class="col-2">
                            <i class="far fa-user-circle fa-2x"></i>
                        </div>
                        <div class="col">
                            <div class="row">
                                <div class="col fs-6">Pooh</div>
                            </div>
                            <div class="row">
                                <div class="col text-secondary fs-6">@Pooh</div>
                            </div>
                        </div>
                    </div>
                </h5>
                <p class="card-text text-secondary fs-6">Winnie-the-Pooh, also called Pooh Bear and Pooh, is a fictional anthropomorphic teddy bear created by English author A. A. Milne and English illustrator E. H. Shepard.</p>
                <p class="card-text text-secondary fs-6">
                    <span><i class="far fa-heart"></i> 4.5</span><span class="ms-3">09:30 Nov 14, 2018</span>
                </p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-dark" data-bs-dismiss="modal" onclick="accept();">Accept</button>
            <button type="button" class="btn btn-dark" data-bs-dismiss="modal" onclick="reject();">Reject</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
