<!doctype html>
<html lang="en" class="h-100 w-100">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->
    <meta name="description" content="">
    <meta name="author" content="">
    <meta itemprop="name" content="">
    <meta name="generator" content="">
    <meta itemprop="image" content="">
    <meta name="mobile-web-app-capable" content="yes">
    <title>X WEB VIDEO CHAT</title>
    <!-- <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/cover/"> -->
    <link href="./fontawesome/css/all.css" rel="stylesheet">
    <link href="./bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>
    <link href="cover.css" rel="stylesheet">
    <script src="./bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="./axios/axios.js"></script>
    <script>
      
      const configuration = {}; // SET STUN & TUN
      class xWebConnection {
        constructor(id) {
          this._id = id;
          this._stream = null;
          this._video = document.getElementById('videoChatView');
          this._connection = new RTCPeerConnection(configuration);
        }

        get id() {
          return this._id;
        }

        get connection() {
          return this._connection;
        }

        async start(chat, from) {
          const constraints = { audio: true, video: true };
          console.log(navigator);
          console.log(navigator.mediaDevices);
          this._stream = await navigator.mediaDevices.getUserMedia(constraints);
          this._video.srcObject = this._stream;
          this._stream.getTracks().forEach(track => this._connection.addTrack(track, this._stream));
          // this._connection = new RTCPeerConnection(configuration);

          this._connection.addEventListener('icecandidate', e => this.onIceCandidate(chat, e));
          this._connection.addEventListener('iceconnectionstatechange', e => this.onIceConnectionStateChange(e));
          this._connection.addEventListener('track', e => this.onTrack(e));
          
          await this.offer(chat, from);
        }

        async offer(chat, from) {
          const offer = await this._connection.createOffer({ offerToReceiveAudio: 1, offerToReceiveVideo: 1 });
          await this._connection.setLocalDescription(offer);
          chat.client.send(JSON.stringify({message: 'offer', to: from, from: this._id, offer}));

        }

        async answer(chat, json) {
          const constraints = { audio: true, video: true };
          this._stream = await navigator.mediaDevices.getUserMedia(constraints);
          this._stream.getTracks().forEach(track => this._connection.addTrack(track, this._stream));
          this._video.srcObject = this._stream;
          // this._connection = new RTCPeerConnection(configuration);

          this._connection.addEventListener('icecandidate', e => this.onIceCandidate(chat, e));
          this._connection.addEventListener('iceconnectionstatechange', e => this.onIceConnectionStateChange(e));
          this._connection.addEventListener('track', e => this.onTrack(e));

          await this._connection.setRemoteDescription(new RTCSessionDescription(json.offer));
          const answer = await this._connection.createAnswer();
          await this._connection.setLocalDescription(answer);

          chat.client.send(JSON.stringify({message: 'answer', to: json.from, from: this._id, answer}));
        }

        async handshake(json) {
          await this._connection.setRemoteDescription(new RTCSessionDescription(json.answer));
        }

        onIceCandidate(chat, e) {
          console.log(e);
          if(this === chat.from) {
            const data = JSON.stringify({message: 'candidate', to: chat.to, from: this._id, candidate: e.candidate});
            console.log(data);
            chat.client.send(data);
          } else {
            const data = JSON.stringify({message: 'candidate', to: chat.from, from: this._id, candidate: e.candidate});
            console.log(data);
            chat.client.send(data);
          }
        }

        onIceConnectionStateChange(e) {
          console.log('================================================');
          console.log(e);
        }

        onTrack(e) {
          console.log(e);
          this._video.srcObject = e.streams[0];
        }
      }

      class xWebVideoChat {
        constructor(userid, from, to) {
          this.o = null;
          this.to = null;
          this.from = null;
          this.client =  new WebSocket("ws://ec2-3-142-79-180.us-east-2.compute.amazonaws.com:3030/", "protocolOne");
          this.userid = userid;
          this.client.onopen = event => {
            this.client.send(JSON.stringify({message: 'wait', userid: this.userid, to: to, from: from}));
          };
          this.client.onmessage = async event => {
            const json = JSON.parse(event.data);
            console.log(json);
            if(json.message === 'wait') {
              // TO == USER
              this.o = this.to = new xWebConnection(to);
              this.from = from;
              await this.to.start(this, from, this.from);
            } else if(json.message === 'offer') {
              // FROM == USER
              this.o = this.from = new xWebConnection(from);
              this.to =  to;
              await this.from.answer(this, json, this.to);
              console.log(json);
            } else if(json.message === 'answer') {
              // TO == USER
              await this.to.handshake(json);
              console.log(json);
            } else if(json.message === 'candidate') {
              console.log("-----------------------------------");
              console.log(json);
              console.log("-----------------------------------");
              if(json.candidate) {
                await this.o.connection.addIceCandidate(json.candidate);
              }
            } else {
            }
          };
          this.client.onclose = event => {
            console.log(event);
          };
        }
      };
      const urlParams = new URLSearchParams(window.location.search);
      let chat = null;

      function onChatViewLoad() {
        if (navigator.mediaDevices === undefined) {
          navigator.mediaDevices = {};
        }
        if (navigator.mediaDevices.getUserMedia === undefined) {
          navigator.mediaDevices.getUserMedia = function(constraints) {

            // First get ahold of the legacy getUserMedia, if present
            var getUserMedia = navigator.getUserMedia ||
                              navigator.webkitGetUserMedia ||
                              navigator.mozGetUserMedia ||
                              navigator.msGetUserMedia;

            // Some browsers just don't implement it - return a rejected promise with an error
            // to keep a consistent interface
            if (!getUserMedia) {
              return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
            }

            // Otherwise, wrap the call to the old navigator.getUserMedia with a Promise
            return new Promise(function(resolve, reject) {
              getUserMedia.call(navigator, constraints, resolve, reject);
            });
          }
        }
        chat = new xWebVideoChat(urlParams.get('userid'), urlParams.get('from'), urlParams.get('to'));
      }
    </script>
  </head>
  <body class="d-flex h-100 w-100 text-center text-white bg-dark" onload="onChatViewLoad();">
    <div class="container d-flex w-100 h-100 p-3 flex-column">
      <div class="row justify-content-center">
        <header class="mb-3 align-items-start justify-content-center" style="max-width: 42em;">
            <div>
            <h3 class="float-md-start mb-0"><strong>X WEB VIDEO CHAT</strong></h3>
            <nav class="nav nav-masthead justify-content-center float-md-end">
                <a class="nav-link active" aria-current="page" href="#">HOME</a>
                <a class="nav-link" href="#">FEATURES</a>
                <a class="nav-link" href="#">LOGOUT</a>
            </nav>
            </div>
        </header>
        <footer class="text-white-50 justify-content-center" style="max-width: 42em;">
            <p>
            NOVEMBERIZING / PROJECT X / WEB VIDEO CHAT / LICENSE
            </p>
        </footer>
        <main class="mb-3 px-3 text-start row justify-content-center" style="width: 64rem;">
            <!-- style="width: 18rem;" -->
            <hr />
            <div class="row">
              <div class="col-7">
                <div id="carouselExampleCaptions" class="carousel slide" data-bs-ride="carousel">
                  <div class="carousel-indicators">
                    <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                    <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="1" aria-label="Slide 2"></button>
                    <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="2" aria-label="Slide 3"></button>
                  </div>
                  <div class="carousel-inner">
                    <div class="carousel-item active">
                      <img src="./img/20211215_070107.png" class="d-block w-100" alt="...">
                      <div class="carousel-caption d-none d-md-block">
                        <h5>First slide label</h5>
                        <p>Some representative placeholder content for the first slide.</p>
                      </div>
                    </div>
                    <div class="carousel-item">
                      <img src="./img/20211215_070111.png" class="d-block w-100" alt="...">
                      <div class="carousel-caption d-none d-md-block">
                        <h5>Second slide label</h5>
                        <p>Some representative placeholder content for the second slide.</p>
                      </div>
                    </div>
                    <div class="carousel-item">
                      <img src="./img/20211215_070115.png" class="d-block w-100" alt="...">
                      <div class="carousel-caption d-none d-md-block">
                        <h5>Third slide label</h5>
                        <p>Some representative placeholder content for the third slide.</p>
                      </div>
                    </div>
                  </div>
                  <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                  </button>
                </div>
              </div>
              <div class="col-5">
                <div class="card bg-transparent text-dark text-white border border-secondary">
                  <div class="card-body">
                    <!-- VIDEO -->
                    <video id="videoChatView" autoplay playsinline controls="false" style="width: 100%;"></video>
                  </div>
                </div>
                <div class="card bg-transparent text-dark text-white border border-secondary mt-2">
                  <div class="card-body">
                    <h5 class="card-title">
                      <div class="row">
                        <div class="col-2">
                          <i class="far fa-user-circle fa-2x"></i>
                        </div>
                        <div class="col">
                          <div class="row">
                            <div class="col fs-6">Pooh</div>
                          </div>
                          <div class="row">
                            <div class="col text-secondary fs-6">@Pooh</div>
                          </div>
                        </div>
                      </div>
                    </h5>
                    <p class="card-text text-secondary fs-6">Winnie-the-Pooh, also called Pooh Bear and Pooh, is a fictional anthropomorphic teddy bear created by English author A. A. Milne and English illustrator E. H. Shepard.</p>
                    <hr />
                    <div class="card-text text-secondary fs-6">
                      <p class="mb-1">What day is it?</p>
                      <p class="mb-1">It's today! Oh, it's my favorite day.</p>
                    </div>
                    <div>
                      <div class="mb-1 mt-3">
                        <form class="row g-3">
                          <div class="col-9">
                            <label for="inputPassword2" class="visually-hidden">Password</label>
                            <input type="text" class="form-control form-control-sm bg-transparent border border-secondary text-white" id="inputPassword2" placeholder="Comment">
                          </div>
                          <div class="col-3">
                            <button type="submit" class="btn btn-light btn-sm mb-3">Write</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </main>
      </div>
    </div>
  </body>
</html>
